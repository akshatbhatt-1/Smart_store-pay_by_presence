import cv2
import insightface

# Load InsightFace face detection + recognition model
app = insightface.app.FaceAnalysis(
    name="buffalo_l",                 # high accuracy (CPU)
    providers=["CPUExecutionProvider"]
)

# Prepare model
app.prepare(ctx_id=0, det_size=(640, 640))

# Open camera (0 = default webcam)
cap = cv2.VideoCapture(0)

if not cap.isOpened():
    print("❌ Camera not accessible")
    exit()

print("✅ Face Detection Started (Press ESC to exit)")

while True:
    ret, frame = cap.read()
    if not ret:
        print("❌ Failed to read frame")
        break

    # Detect faces
    faces = app.get(frame)

    # Draw bounding boxes
    for face in faces:
        x1, y1, x2, y2 = face.bbox.astype(int)
        cv2.rectangle(
            frame,
            (x1, y1),
            (x2, y2),
            (0, 255, 0),
            2
        )

    cv2.imshow("1B - Face Detection", frame)

    if cv2.waitKey(1) == 27:  # ESC key
        break

cap.release()
cv2.destroyAllWindows()
